name: TROFIC Cron Fetch

on:
  schedule:
    # every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install requests

      - name: Run fetch script (writes data/*.csv)
        run: |
          python scripts/fetch_tuya.py
        env:
          TUYA_ACCESS_ID: ${{ secrets.TUYA_ACCESS_ID }}
          TUYA_ACCESS_KEY: ${{ secrets.TUYA_ACCESS_KEY }}
          STORAGE_URL: ${{ secrets.STORAGE_URL }}

      - name: Create manifest of available CSVs
        run: |
          # ensure data dir exists
          mkdir -p data

          # build JSON array listing CSV filenames (base names)
          files=$(ls data/TROFICDORD*.csv 2>/dev/null | xargs -n1 basename | awk 'BEGIN{first=1; printf "["} { if(!first) printf ","; printf "\"%s\"", $0; first=0 } END{ printf "]" }')
          if [ -z "$files" ] || [ "$files" = "[]" ]; then
            echo "[]" > data/manifest.json
          else
            echo "$files" > data/manifest.json
          fi
          echo "Manifest written: $(cat data/manifest.json)"

      - name: Publish to gh-pages branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH=gh-pages
          WORKTREE=/tmp/gh-pages

          if git ls-remote --exit-code origin $BRANCH; then
            echo "$BRANCH exists, creating temporary worktree"
            git fetch origin $BRANCH
            rm -rf $WORKTREE
            git worktree add $WORKTREE origin/$BRANCH || true
          else
            echo "$BRANCH does not exist, creating orphan branch in worktree"
            rm -rf $WORKTREE
            mkdir -p $WORKTREE
            git worktree add $WORKTREE --detach
            pushd $WORKTREE
            git checkout --orphan $BRANCH || true
            git rm -rf . || true
            git commit --allow-empty -m "Initialize gh-pages" || true
            git push origin $BRANCH || true
            popd
          fi

          # Copy generated data and web/index.html into the gh-pages worktree
          rm -rf $WORKTREE/*
          cp -r data "$WORKTREE/" || true
          cp -r web/index.html "$WORKTREE/index.html" || true

          # Use token auth for pushing
          git -C $WORKTREE remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

          pushd $WORKTREE
          git add --all
          if git diff --staged --quiet; then
            echo "No changes to publish"
          else
            git commit -m "Automated data update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push origin HEAD:$BRANCH
          fi
          popd
