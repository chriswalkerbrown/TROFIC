name: TROFIC Cron Fetch

on:
  schedule:
    # every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install requests

      - name: Run fetch script (writes data/*.csv)
        run: |
          python scripts/fetch_tuya.py
        env:
          TUYA_ACCESS_ID: ${{ secrets.TUYA_ACCESS_ID }}
          TUYA_ACCESS_KEY: ${{ secrets.TUYA_ACCESS_KEY }}
          STORAGE_URL: ${{ secrets.STORAGE_URL }}

      - name: Create manifest of available CSVs
        run: |
          # ensure data dir exists
          mkdir -p data

          # build JSON array listing CSV filenames (base names)
          files=$(ls data/TROFICDORD*.csv 2>/dev/null | xargs -n1 basename | awk 'BEGIN{first=1; printf "["} { if(!first) printf ","; printf "\"%s\"", $0; first=0 } END{ printf "]" }')
          if [ -z "$files" ] || [ "$files" = "[]" ]; then
            echo "[]" > data/manifest.json
          else
            echo "$files" > data/manifest.json
          fi
          echo "Manifest written: $(cat data/manifest.json)"

      - name: Publish to gh-pages branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH=gh-pages
          WORKTREE=/tmp/gh-pages

          # Remove existing worktree if present
          git worktree remove $WORKTREE 2>/dev/null || true
          rm -rf $WORKTREE

          if git ls-remote --exit-code origin $BRANCH; then
            echo "$BRANCH exists, creating temporary worktree"
            git fetch origin $BRANCH
            git worktree add $WORKTREE origin/$BRANCH
          else
            echo "$BRANCH does not exist, creating orphan branch"
            git worktree add --detach $WORKTREE
            cd $WORKTREE
            git checkout --orphan $BRANCH
            git rm -rf . 2>/dev/null || true
            git commit --allow-empty -m "Initialize gh-pages"
            cd -
          fi

          # Clear gh-pages content (but keep .git)
          cd $WORKTREE
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd -

          # Copy data directory
          if [ -d "data" ]; then
            cp -r data $WORKTREE/
            echo "Copied data directory"
            ls -la $WORKTREE/data/
          else
            echo "WARNING: data directory not found"
          fi

          # Copy index.html - ONLY from web/ directory
          if [ -f "web/index.html" ]; then
            cp web/index.html $WORKTREE/index.html
            echo "Copied web/index.html"
            echo "Content preview:"
            head -n 5 $WORKTREE/index.html
          else
            echo "ERROR: web/index.html not found"
            echo "Current directory contents:"
            ls -la
            echo "web/ directory contents:"
            ls -la web/ 2>/dev/null || echo "web/ directory does not exist"
            exit 1
          fi

          # Commit and push
          cd $WORKTREE
          git add --all
          
          if git diff --staged --quiet; then
            echo "No changes to publish"
          else
            git commit -m "Automated data update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push origin HEAD:$BRANCH
            echo "Successfully pushed to gh-pages"
          fi
          
          cd -
          git worktree remove $WORKTREE
