name: TROFIC Cron Fetch

on:
  schedule:
    # every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install requests

      - name: Run fetch script (writes data/*.csv)
        run: |
          python scripts/fetch_tuya.py
        env:
          TUYA_ACCESS_ID: ${{ secrets.TUYA_ACCESS_ID }}
          TUYA_ACCESS_KEY: ${{ secrets.TUYA_ACCESS_KEY }}
          STORAGE_URL: ${{ secrets.STORAGE_URL }}

      - name: Create manifest of available CSVs
        run: |
          python - <<'PY'
import json, os
p = 'data'
files = []
if os.path.isdir(p):
    files = sorted([f for f in os.listdir(p) if f.startswith('TROFICDORD') and f.endswith('.csv')])
else:
    os.makedirs(p, exist_ok=True)
with open(os.path.join(p,'manifest.json'),'w') as fh:
    json.dump(files, fh)
print('Manifest written with', len(files), 'entries')
PY

      - name: Publish to gh-pages branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Prepare a temporary worktree to create/update gh-pages from current repo state
          BRANCH=gh-pages

          if git ls-remote --exit-code origin $BRANCH; then
            echo "$BRANCH exists, creating temporary worktree"
            git fetch origin $BRANCH
            git worktree add /tmp/gh-pages origin/$BRANCH || true
          else
            echo "$BRANCH does not exist, create orphan branch in worktree"
            mkdir -p /tmp/gh-pages
            git worktree add /tmp/gh-pages --detach
            pushd /tmp/gh-pages
            git checkout --orphan $BRANCH || true
            git rm -rf . || true
            git commit --allow-empty -m "Initialize gh-pages" || true
            git push origin $BRANCH || true
            popd
          fi

          # Copy generated data and web/index.html into the gh-pages worktree
          rm -rf /tmp/gh-pages/*
          cp -r data /tmp/gh-pages/ || true
          mkdir -p /tmp/gh-pages
          cp -r web/index.html /tmp/gh-pages/index.html || true

          pushd /tmp/gh-pages
          git add --all
          if git diff --staged --quiet; then
            echo "No changes to publish"
          else
            git commit -m "Automated data update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push origin HEAD:$BRANCH
          fi
          popd
